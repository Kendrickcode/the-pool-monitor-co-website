<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Pool Monitor Co. - Admin Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .data-table {
            border-collapse: separate;
            border-spacing: 0 10px;
        }
        .data-table th, .data-table td {
            padding: 12px 16px;
        }
        .header-bg {
            background-color: #0077c2;
        }
        .shadow-custom {
            box-shadow: 0 10px 15px -3px rgba(0, 119, 194, 0.1), 0 4px 6px -2px rgba(0, 119, 194, 0.05);
        }
    </style>
</head>
<body>

    <main class="min-h-screen p-4 sm:p-8">

        <!-- Header and Logout Button -->
        <header id="dashboard-header" class="bg-white shadow-custom rounded-xl p-4 mb-8 hidden flex justify-between items-center sticky top-4 z-10">
            <h1 class="text-3xl font-extrabold text-[#0077c2]">Admin Dashboard</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info" class="text-sm text-gray-600"></span>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                    Logout
                </button>
            </div>
        </header>


        <!-- Login Form (Initially Visible) -->
        <!-- FIX: Removed 'hidden' class so the form appears immediately upon page load. -->
        <div id="login-container" class="max-w-md mx-auto p-8 bg-white rounded-xl shadow-2xl mt-20">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Admin Access Required</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="admin-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="admin-email" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#0077c2] focus:border-[#0077c2]">
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="admin-password" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#0077c2] focus:border-[#0077c2]">
                </div>
                <button type="submit" class="w-full bg-[#0077c2] text-white py-3 rounded-xl font-bold hover:bg-[#005a96] transition duration-150">
                    Sign In
                </button>
                <p id="login-message" class="mt-3 text-center text-sm text-red-600 hidden"></p>
            </form>
        </div>


        <!-- Dashboard Content (Hidden until login) -->
        <div id="dashboard-content" class="hidden">
            <!-- HOA Inquiry Leads Table -->
            <section class="mb-12">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">HOA Inquiry Leads</h2>
                <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                    <table class="w-full data-table">
                        <thead class="text-left text-white header-bg rounded-t-xl">
                            <tr>
                                <th class="rounded-tl-xl">ID (Submitted By)</th>
                                <th>Timestamp</th>
                                <th>Property / HOA</th>
                                <th>Email</th>
                                <th>Needs</th>
                                <th class="rounded-tr-xl">Action</th>
                            </tr>
                        </thead>
                        <tbody id="hoa-leads">
                            <!-- HOA Leads will be injected here -->
                            <tr><td colspan="6" class="text-center py-4 text-gray-500">Loading leads or no data found...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Staff Application Leads Table -->
            <section>
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Staff Applications</h2>
                <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                    <table class="w-full data-table">
                        <thead class="text-left text-white header-bg rounded-t-xl">
                            <tr>
                                <th class="rounded-tl-xl">ID (Submitted By)</th>
                                <th>Timestamp</th>
                                <th>Full Name</th>
                                <th>Certification</th>
                                <th>Availability</th>
                                <th class="rounded-tr-xl">Action</th>
                            </tr>
                        </thead>
                        <tbody id="staff-leads">
                            <!-- Staff Leads will be injected here -->
                            <tr><td colspan="6" class="text-center py-4 text-gray-500">Loading applications or no data found...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

    </main>


    <script type="module">
        // 1. Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 2. Global Firebase/App Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-poolmonitor-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        let app, db, auth;
        let userId = null;
        
        // Log setup for debugging
        if (typeof setLogLevel !== 'undefined') { setLogLevel('Debug'); }

        const loginContainer = document.getElementById('login-container');
        const dashboardContent = document.getElementById('dashboard-content');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const loginMessage = document.getElementById('login-message');
        const dashboardHeader = document.getElementById('dashboard-header');
        const userInfoSpan = document.getElementById('user-info');

        /**
         * Initializes Firebase and sets up the Auth listener.
         */
        function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Set up the Authentication State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user && user.email === 'admin@mypoolmonitor.com') {
                        // User is signed in and is the Admin
                        userId = user.uid;
                        console.log("Admin signed in. User ID:", userId);
                        showDashboard(user);
                        setupRealtimeListeners();
                    } else {
                        // User is signed out or is not the admin
                        showLogin();
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        // --- UI TOGGLE FUNCTIONS ---

        function showDashboard(user) {
            loginContainer.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
            dashboardHeader.classList.remove('hidden');
            userInfoSpan.textContent = `Logged in as: ${user.email}`;
        }

        function showLogin() {
            // Note: Login container is already visible by default due to HTML change
            dashboardContent.classList.add('hidden');
            dashboardHeader.classList.add('hidden');
            loginContainer.classList.remove('hidden'); // Ensure it's not hidden if logged out
            loginMessage.textContent = '';
            loginMessage.classList.add('hidden');
            if (loginForm) loginForm.reset();
        }

        // --- AUTH LOGIC ---

        loginForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            loginMessage.textContent = 'Signing in...';
            loginMessage.classList.remove('hidden');
            loginMessage.classList.remove('text-red-600');
            loginMessage.classList.add('text-gray-600');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // Extra check to ensure only the specified admin account gets through,
                // although Firebase security rules should handle this better on the backend.
                if (userCredential.user.email !== 'admin@mypoolmonitor.com') {
                    await signOut(auth); // Immediately sign out if wrong email somehow got through
                    throw new Error("Access denied. Incorrect admin account.");
                }
                // onAuthStateChanged handles showing the dashboard
            } catch (error) {
                console.error("Login failed:", error.code, error.message);
                loginMessage.textContent = `Login Failed. Check credentials. (${error.code})`;
                loginMessage.classList.remove('text-gray-600');
                loginMessage.classList.add('text-red-600');
            }
        });

        logoutButton?.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("User signed out.");
                // onAuthStateChanged handles showing the login form
            } catch (error) {
                console.error("Logout failed:", error);
            }
        });

        // --- DATA LOGIC ---

        /**
         * Renders the data array into the specified table body.
         * @param {Array} data - Array of document objects from Firestore.
         * @param {HTMLElement} tableBodyId - The ID of the <tbody> element.
         * @param {string} type - 'hoa' or 'staff' to determine which fields to render.
         */
        function renderLeads(data, tableBodyId, type) {
            const tbody = document.getElementById(tableBodyId);
            tbody.innerHTML = ''; // Clear existing rows

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No ${type} leads found.</td></tr>`;
                return;
            }

            data.forEach(doc => {
                const docId = doc.id;
                const lead = doc.data;
                const date = lead.timestamp ? new Date(lead.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                
                let mainFields = '';
                if (type === 'hoa') {
                    mainFields = `
                        <td>${lead['hoa-name'] || 'N/A'}</td>
                        <td><a href="mailto:${lead['hoa-email']}" class="text-[#0077c2] hover:underline">${lead['hoa-email'] || 'N/A'}</a></td>
                        <td class="whitespace-normal max-w-xs">${lead['hoa-needs'] || 'N/A'}</td>
                    `;
                } else if (type === 'staff') {
                    mainFields = `
                        <td>${lead['staff-name'] || 'N/A'}</td>
                        <td>${lead['staff-cert'] || 'N/A'}</td>
                        <td class="whitespace-normal max-w-xs">${lead['staff-avail'] || 'N/A'}</td>
                    `;
                }

                const row = `
                    <tr class="bg-white border-b border-gray-100 hover:bg-gray-50 transition duration-150 rounded-xl">
                        <td class="font-mono text-xs text-gray-500">${docId.substring(0, 8)}...</td>
                        <td>${date}</td>
                        ${mainFields}
                        <td>
                            <button onclick="window.deleteLead('${collection(db, `artifacts/${appId}/users/${userId}/${type}_applications`).path}/${docId}')"
                                class="bg-red-100 text-red-700 hover:bg-red-200 text-xs font-bold py-1 px-3 rounded-full transition duration-150">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        /**
         * Sets up real-time listeners for both lead collections.
         */
        function setupRealtimeListeners() {
            if (!db || !userId) {
                console.error("Database not initialized or user not logged in.");
                return;
            }

            const hoaPath = `artifacts/${appId}/users/${userId}/hoa_inquiries`;
            const staffPath = `artifacts/${appId}/users/${userId}/staff_applications`;

            // HOA Leads Listener
            onSnapshot(collection(db, hoaPath), (snapshot) => {
                const leads = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderLeads(leads, 'hoa-leads', 'hoa');
            }, (error) => {
                console.error("Error fetching HOA leads:", error);
                document.getElementById('hoa-leads').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading data.</td></tr>`;
            });

            // Staff Leads Listener
            onSnapshot(collection(db, staffPath), (snapshot) => {
                const leads = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderLeads(leads, 'staff-leads', 'staff');
            }, (error) => {
                console.error("Error fetching Staff leads:", error);
                document.getElementById('staff-leads').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading data.</td></tr>`;
            });
        }
        
        /**
         * Deletes a document from Firestore. Attached to window for inline access.
         * @param {string} docPath - The full path to the document (e.g., 'artifacts/appId/users/userId/collectionName/docId').
         */
        window.deleteLead = async function(docPath) {
            if (!confirm("Are you sure you want to permanently delete this lead?")) {
                return;
            }
            try {
                // The path format is collection/docId/collection/docId...
                // We need to resolve the document reference from the path string
                const pathSegments = docPath.split('/').filter(s => s.length > 0);
                
                // Firebase doc function accepts the database instance and then path segments
                const docRef = doc(db, ...pathSegments);

                await deleteDoc(docRef);
                console.log("Document successfully deleted:", docPath);
                // onSnapshot listeners handle the UI update automatically
            } catch (error) {
                console.error("Error removing document: ", error);
            }
        }


        // Start the application
        initializeFirebase();
    </script>

</body>
</html>

